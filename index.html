<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿å±‹ç§Ÿèµæ°´ç”µè´¹ç®¡ç†ç³»ç»Ÿ (ç¦»çº¿æœ¬åœ°ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
            --border-color: #ddd;
        }

        body {
            font-family: 'Segoe UI', "Microsoft YaHei", sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .top-tools {
            text-align: right;
            margin-bottom: 15px;
            font-size: 12px;
        }
        .link-btn {
            color: #666;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 10px;
            background: none;
            border: none;
            font-size: 12px;
        }

        /* å¯¼èˆªæ ‡ç­¾ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 5px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 5px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .page {
            display: none;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .page.active { display: block; }

        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 15px; }
        .form-col { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;}
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; font-size: 14px;}
        input:read-only { background-color: #e9ecef; }
        input.money-input { border-color: #28a745; }

        button.action-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            margin-top: 10px;
        }

        /* --- è´¦å•é¢„è§ˆåŒºåŸŸä¼˜åŒ– --- */
        .bill-scroll-container {
            width: 100%;
            overflow-x: auto; /* å…³é”®ï¼šæ‰‹æœºç«¯æ”¯æŒæ¨ªå‘æ»šåŠ¨ */
            margin-top: 20px;
            border: 1px solid #ccc;
            background: #fff;
        }

        .bill-preview {
            min-width: 550px; /* ä¿è¯è¡¨æ ¼å†…å®¹ä¸æŒ¤å‹ */
            padding: 30px 20px;
            background: #fff;
            position: relative;
        }

        .bill-header { text-align: center; margin-bottom: 20px; }
        .bill-header h3 { margin: 5px 0; font-size: 22px; color: #000; }
        .bill-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
        }

        table.bill-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        table.bill-table th, table.bill-table td {
            border: 1px solid #000;
            padding: 8px 4px;
            text-align: center;
            font-size: 13px;
        }
        table.bill-table th { background-color: #f2f2f2; }

        .total-section {
            text-align: right;
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
            border-top: 2px solid #000;
            padding-top: 10px;
        }

        .bill-footer {
            margin-top: 20px;
            font-size: 12px;
            text-align: right;
            color: #444;
        }

        /* å“åº”å¼æ‰‹æœºç«¯ç‰¹æ®Šå¤„ç† */
        @media (max-width: 600px) {
            .form-row { flex-direction: column; gap: 0; }
            body { padding: 5px; }
            .page { padding: 15px; }
            .bill-preview { padding: 20px 10px; }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            display: none;
            z-index: 9999;
        }
    </style>
</head>
<body>

<div id="auth-page" style="max-width: 400px; margin: 50px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center;">
    <h2>ç®¡ç†å‘˜ç™»å½•</h2>
    <p style="color:red; font-size: 14px;">åˆå§‹å¯†ç ï¼š123456</p>
    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " style="margin-bottom: 15px;">
    <button class="action-btn" onclick="localLogin()">è¿›å…¥ç³»ç»Ÿ</button>
</div>

<div id="app-content" style="display:none;">
    <div class="container">
        <div class="top-tools">
            <button class="link-btn" onclick="localLogout()">é€€å‡º</button>
            <button class="link-btn" onclick="exportData()">å¤‡ä»½æ•°æ®</button>
            <button class="link-btn" onclick="document.getElementById('fileInput').click()">æ¢å¤æ•°æ®</button>
            <input type="file" id="fileInput" style="display:none" onchange="importData(this)" accept=".json">
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('record')">ğŸ“ æŠ„è¡¨å½•å…¥</button>
            <button class="tab-btn" onclick="switchTab('display')">ğŸ§¾ ç”Ÿæˆè´¦å•</button>
        </div>

        <div id="record-page" class="page active">
            <form id="recordForm">
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>é€‰æ‹©æˆ¿å·</label>
                        <select id="inputRoom" onchange="loadSmartPrevData()"></select>
                    </div>
                    <div class="form-col form-group">
                        <label>æŠ„è¡¨æ—¥æœŸ</label>
                        <input type="date" id="inputDate" onchange="loadSmartPrevData()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>å›ºå®šæˆ¿ç§Ÿ</label>
                        <input type="number" id="inputRent" class="money-input">
                    </div>
                    <div class="form-col form-group">
                        <label>æŠ¼é‡‘é‡‘é¢</label>
                        <input type="number" id="inputDeposit" class="money-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>ä¸Šæ¬¡æ°´è¡¨: <span id="txtPrevWaterDate" style="font-weight:normal;font-size:12px">--</span></label>
                        <input type="number" id="prevWater" readonly>
                    </div>
                    <div class="form-col form-group">
                        <label>æœ¬æ¬¡æ°´è¡¨</label>
                        <input type="number" id="currWater" placeholder="è¾“å…¥è¯»æ•°">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>ä¸Šæ¬¡ç”µè¡¨: <span id="txtPrevElecDate" style="font-weight:normal;font-size:12px">--</span></label>
                        <input type="number" id="prevElec" readonly>
                    </div>
                    <div class="form-col form-group">
                        <label>æœ¬æ¬¡ç”µè¡¨</label>
                        <input type="number" id="currElec" placeholder="è¾“å…¥è¯»æ•°">
                    </div>
                </div>
                <button type="button" class="action-btn" onclick="saveRecord()">ä¿å­˜æœ¬æ¬¡è®°å½•</button>
            </form>
        </div>

        <div id="display-page" class="page">
            <div class="form-row" style="align-items: flex-end;">
                <div class="form-col form-group">
                    <label>é€‰æ‹©æˆ¿å·</label>
                    <select id="viewRoom" onchange="populateRecordDates()"></select>
                </div>
                <div class="form-col form-group">
                    <label>é€‰æ‹©æŠ„è¡¨è®°å½•</label>
                    <select id="viewRecordDate"></select>
                </div>
            </div>
            <button class="action-btn" onclick="generateBill()">ç”Ÿæˆé¢„è§ˆè´¦å•</button>
            
            <div id="billWrapper" style="display:none;">
                <p style="font-size:12px; color:#999; text-align:center; margin-top:15px;">â¬…ï¸ æ‰‹æœºç«¯å¯å·¦å³æ»‘åŠ¨æŸ¥çœ‹å®Œæ•´è¡¨æ ¼ â¡ï¸</p>
                
                <div class="bill-scroll-container">
                    <div id="billArea" class="bill-preview">
                        <div class="bill-header">
                            <h3>æˆ¿å±‹ç§Ÿèµè´¹æ°´ç”µè´¹ç»“ç®—å•</h3>
                            <p>è´¹ç”¨æ‰€å±æœˆä»½ï¼š<span id="billMonthTitle" style="font-weight:bold;">--</span></p>
                        </div>
                        <div class="bill-info">
                            <span id="billRoom">æˆ¿å·ï¼š--</span>
                            <span id="billDate">æŠ„è¡¨æ—¥ï¼š--</span>
                        </div>
                        <table class="bill-table">
                            <thead>
                                <tr>
                                    <th>é¡¹ç›®</th>
                                    <th>ä¸Šæ¬¡è¯»æ•°</th>
                                    <th>æœ¬æ¬¡è¯»æ•°</th>
                                    <th>å®ç”¨é‡</th>
                                    <th>å•ä»·</th>
                                    <th>é‡‘é¢ (å…ƒ)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>æ°´è´¹</td><td id="tPrevWater"></td><td id="tCurrWater"></td><td id="tUseWater"></td><td>5.00</td><td id="tCostWater"></td></tr>
                                <tr><td>ç”µè´¹</td><td id="tPrevElec"></td><td id="tCurrElec"></td><td id="tUseElec"></td><td>0.80</td><td id="tCostElec"></td></tr>
                                <tr><td>æˆ¿ç§Ÿ</td><td colspan="4">å›ºå®šæœˆç§Ÿ</td><td id="tRent"></td></tr>
                                <tr style="color:#666; background:#f9f9f9;"><td>æŠ¼é‡‘</td><td colspan="4">å½“å‰åœ¨æŠ¼é‡‘é¢ (ä»…å±•ç¤º)</td><td id="tDeposit"></td></tr>
                            </tbody>
                        </table>
                        <div class="total-section">
                            åˆè®¡åº”ç¼´ï¼š<span style="color:red; font-size:24px;">Â¥ <span id="tTotal">0.00</span></span>
                        </div>
                        <div class="bill-footer">è¯·åŠæ—¶é€šè¿‡å¾®ä¿¡æˆ–æ”¯ä»˜å®ç¼´çº³ï¼Œè°¢è°¢é…åˆã€‚</div>
                    </div>
                </div>
                
                <button class="action-btn" style="background-color:#28a745;" onclick="downloadBillImage()">ğŸ“¸ ç‚¹å‡»ä¸‹è½½è´¦å•å›¾ç‰‡åˆ°ç›¸å†Œ</button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    // [åŸºç¡€é€»è¾‘éƒ¨åˆ†ä¸åŸä»£ç ä¸€è‡´ï¼Œæ­¤å¤„ç²¾ç®€å±•ç¤ºæ ¸å¿ƒä¿®æ”¹ç‚¹]
    const DB_KEY = 'RENT_MANAGER_DATA';
    const ADMIN_PASSWORD = '123456';
    const ROOM_LIST = ["101", "201", "202", "203", "204", "301", "302", "303", "304"];
    const PRICE_WATER = 5.0;
    const PRICE_ELEC = 0.8;
    let db = [];

    window.onload = function() {
        if (sessionStorage.getItem('isLoggedIn') === 'true') handleLoginState(true);
        document.getElementById('inputDate').valueAsDate = new Date();
    };

    function handleLoginState(isLoggedIn) {
        document.getElementById('auth-page').style.display = isLoggedIn ? 'none' : 'block';
        document.getElementById('app-content').style.display = isLoggedIn ? 'block' : 'none';
        if (isLoggedIn) { initDB(); populateSelects(); }
    }

    function localLogin() {
        if (document.getElementById('loginPassword').value === ADMIN_PASSWORD) {
            sessionStorage.setItem('isLoggedIn', 'true');
            handleLoginState(true);
        } else { alert("å¯†ç é”™è¯¯ï¼"); }
    }

    function localLogout() {
        sessionStorage.removeItem('isLoggedIn');
        location.reload();
    }

    // --- æ•°æ®æŒä¹…åŒ– ---
    function getDB() {
        db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        return db;
    }
    function saveDB(data) {
        localStorage.setItem(DB_KEY, JSON.stringify(data));
        db = data;
    }
    function initDB() {
        if (getDB().length === 0) {
            const initial = ROOM_LIST.map(r => ({ æˆ¿å·: r, å›ºå®šç§Ÿé‡‘: 3000, æŠ¼é‡‘: 3000, æ°´ç”µè´¹è®°å½•: [] }));
            saveDB(initial);
        }
    }

    // --- ç•Œé¢é€»è¾‘ ---
    function populateSelects() {
        const rooms = getDB();
        const s1 = document.getElementById('inputRoom');
        const s2 = document.getElementById('viewRoom');
        s1.innerHTML = s2.innerHTML = '';
        rooms.forEach(r => {
            s1.add(new Option(r.æˆ¿å·, r.æˆ¿å·));
            s2.add(new Option(r.æˆ¿å·, r.æˆ¿å·));
        });
        loadSmartPrevData();
    }

    function switchTab(t) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t + '-page').classList.add('active');
        event.currentTarget.classList.add('active');
        if(t === 'display') populateRecordDates();
    }

    // è‡ªåŠ¨åŠ è½½ä¸Šæ¬¡æ•°æ®é€»è¾‘ (ä¿æŒåŸæ ·)
    function loadSmartPrevData() {
        const roomId = document.getElementById('inputRoom').value;
        const date = document.getElementById('inputDate').value;
        const tenant = getDB().find(t => t.æˆ¿å· === roomId);
        if(!tenant) return;
        
        document.getElementById('inputRent').value = tenant.å›ºå®šç§Ÿé‡‘;
        document.getElementById('inputDeposit').value = tenant.æŠ¼é‡‘;
        
        const sorted = [...tenant.æ°´ç”µè´¹è®°å½•].sort((a,b) => new Date(b.æ—¥æœŸ) - new Date(a.æ—¥æœŸ));
        const prev = sorted.find(r => new Date(r.æ—¥æœŸ) < new Date(date));
        
        if(prev) {
            document.getElementById('prevWater').value = prev.æœ¬æœˆæ°´è¡¨;
            document.getElementById('prevElec').value = prev.æœ¬æœˆç”µè¡¨;
            document.getElementById('txtPrevWaterDate').innerText = prev.æ—¥æœŸ;
        } else {
            document.getElementById('prevWater').value = 0;
            document.getElementById('prevElec').value = 0;
            document.getElementById('txtPrevWaterDate').innerText = "æ— ";
        }
    }

    function saveRecord() {
        const roomId = document.getElementById('inputRoom').value;
        const date = document.getElementById('inputDate').value;
        const cw = parseFloat(document.getElementById('currWater').value);
        const ce = parseFloat(document.getElementById('currElec').value);
        const pw = parseFloat(document.getElementById('prevWater').value);
        const pe = parseFloat(document.getElementById('prevElec').value);

        if(isNaN(cw) || isNaN(ce)) return alert("è¯·å¡«å†™å®Œæ•´ï¼");
        if(cw < pw || ce < pe) return alert("è¯»æ•°æœ‰è¯¯ï¼");

        const tenants = getDB();
        const idx = tenants.findIndex(t => t.æˆ¿å· === roomId);
        const record = { æ—¥æœŸ: date, ä¸Šæœˆæ°´è¡¨: pw, æœ¬æœˆæ°´è¡¨: cw, ä¸Šæœˆç”µè¡¨: pe, æœ¬æœˆç”µè¡¨: ce, å½“æœˆæˆ¿ç§Ÿå¿«ç…§: parseFloat(document.getElementById('inputRent').value) };
        
        // æ›´æ–°æˆ–æ’å…¥
        const rIdx = tenants[idx].æ°´ç”µè´¹è®°å½•.findIndex(r => r.æ—¥æœŸ === date);
        if(rIdx > -1) tenants[idx].æ°´ç”µè´¹è®°å½•[rIdx] = record;
        else tenants[idx].æ°´ç”µè´¹è®°å½•.push(record);
        
        tenants[idx].å›ºå®šç§Ÿé‡‘ = record.å½“æœˆæˆ¿ç§Ÿå¿«ç…§;
        tenants[idx].æŠ¼é‡‘ = parseFloat(document.getElementById('inputDeposit').value);
        
        saveDB(tenants);
        showToast("ä¿å­˜æˆåŠŸï¼");
    }

    function populateRecordDates() {
        const roomId = document.getElementById('viewRoom').value;
        const sel = document.getElementById('viewRecordDate');
        const t = getDB().find(t => t.æˆ¿å· === roomId);
        sel.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
        if(t) t.æ°´ç”µè´¹è®°å½•.reverse().forEach(r => sel.add(new Option(r.æ—¥æœŸ, r.æ—¥æœŸ)));
    }

    function generateBill() {
        const roomId = document.getElementById('viewRoom').value;
        const date = document.getElementById('viewRecordDate').value;
        if(!date) return alert("è¯·é€‰æ‹©æ—¥æœŸ");

        const t = getDB().find(t => t.æˆ¿å· === roomId);
        const r = t.æ°´ç”µè´¹è®°å½•.find(r => r.æ—¥æœŸ === date);
        
        document.getElementById('billWrapper').style.display = 'block';
        
        const wU = r.æœ¬æœˆæ°´è¡¨ - r.ä¸Šæœˆæ°´è¡¨;
        const eU = r.æœ¬æœˆç”µè¡¨ - r.ä¸Šæœˆç”µè¡¨;
        const wC = wU * PRICE_WATER;
        const eC = eU * PRICE_ELEC;
        const rent = r.å½“æœˆæˆ¿ç§Ÿå¿«ç…§;

        document.getElementById('billRoom').innerText = `æˆ¿å·ï¼š${roomId}`;
        document.getElementById('billDate').innerText = `æŠ„è¡¨æ—¥ï¼š${date}`;
        document.getElementById('tPrevWater').innerText = r.ä¸Šæœˆæ°´è¡¨;
        document.getElementById('tCurrWater').innerText = r.æœ¬æœˆæ°´è¡¨;
        document.getElementById('tUseWater').innerText = wU.toFixed(2);
        document.getElementById('tCostWater').innerText = wC.toFixed(2);
        document.getElementById('tPrevElec').innerText = r.ä¸Šæœˆç”µè¡¨;
        document.getElementById('tCurrElec').innerText = r.æœ¬æœˆç”µè¡¨;
        document.getElementById('tUseElec').innerText = eU.toFixed(2);
        document.getElementById('tCostElec').innerText = eC.toFixed(2);
        document.getElementById('tRent').innerText = rent.toFixed(2);
        document.getElementById('tDeposit').innerText = t.æŠ¼é‡‘.toFixed(2);
        document.getElementById('tTotal').innerText = (wC + eC + rent).toFixed(2);
        
        // è‡ªåŠ¨è®¡ç®—æ‰€å±æœˆä»½
        const d = new Date(date);
        d.setMonth(d.getMonth() - 1);
        document.getElementById('billMonthTitle').innerText = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`;
    }

    // --- æ ¸å¿ƒï¼šå¯¼å‡ºå›¾ç‰‡åŠŸèƒ½ ---
    function downloadBillImage() {
        const billArea = document.getElementById('billArea');
        showToast("æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...");
        
        html2canvas(billArea, {
            scale: 2, // æé«˜æ¸…æ™°åº¦
            useCORS: true,
            backgroundColor: "#ffffff"
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `è´¦å•_${document.getElementById('billRoom').innerText}_${document.getElementById('billMonthTitle').innerText}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            showToast("å›¾ç‰‡å·²å¼€å§‹ä¸‹è½½");
        });
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    function exportData() {
        const blob = new Blob([localStorage.getItem(DB_KEY)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "ç§Ÿé‡‘æ•°æ®å¤‡ä»½.json";
        a.click();
    }

    function importData(input) {
        const reader = new FileReader();
        reader.onload = e => {
            saveDB(JSON.parse(e.target.result));
            alert("å¯¼å…¥æˆåŠŸï¼");
            location.reload();
        };
        reader.readAsText(input.files[0]);
    }
</script>
</body>
</html>
