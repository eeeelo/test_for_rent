<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿å±‹ç§Ÿèµæ°´ç”µè´¹ç®¡ç†ç³»ç»Ÿ (ç¦»çº¿æœ¬åœ°ç‰ˆ)</title>
    
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
            --border-color: #ddd;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .top-tools {
            text-align: right;
            margin-bottom: 15px;
            font-size: 12px;
        }
        .link-btn {
            color: #666;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 15px;
            background: none;
            border: none;
            font-size: 12px;
        }
        .link-btn:hover { color: var(--primary-color); }

        /* å¯¼èˆªæ ‡ç­¾ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* é¡µé¢å†…å®¹åŒºåŸŸ */
        .page {
            display: none;
            background: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            animation: fadeIn 0.3s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h2 { margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-col {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box; 
        }

        /* åªè¯»è¾“å…¥æ¡†æ ·å¼ */
        input:read-only {
            background-color: #e9ecef;
            color: #495057;
            border-color: #ced4da;
        }
        
        /* é«˜äº®å¯ç¼–è¾‘çš„é‡‘é¢æ¡† */
        input.money-input {
            background-color: #fff;
            border-color: #28a745; 
        }

        button.action-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            margin-top: 10px;
        }

        button.action-btn:hover {
            background-color: #0056b3;
        }

        /* è´¦å•å±•ç¤ºæ ·å¼ */
        .bill-preview {
            border: 1px solid #999;
            padding: 20px;
            background: #fff;
            margin-top: 20px;
            font-family: 'SimSun', serif; 
        }

        .bill-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .bill-header h3 { margin: 5px 0; font-size: 22px; }
        .bill-header p { margin: 0; font-size: 14px; color: #555; }
        
        .bill-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
        }

        table.bill-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        table.bill-table th, table.bill-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            font-size: 14px;
        }

        table.bill-table th {
            background-color: #f8f9fa;
        }

        .total-section {
            text-align: right;
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
            border-top: 2px solid #333;
            padding-top: 10px;
        }

        .bill-footer {
            margin-top: 30px;
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: flex-end;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 600px) {
            .form-row { flex-direction: column; gap: 0; }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>

<div id="auth-page" style="max-width: 400px; margin: 100px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center;">
    <h2>ç®¡ç†å‘˜ç™»å½• (æœ¬åœ°ç‰ˆ)</h2>
    <p style="color:red; font-weight:bold;">å½“å‰å¯†ç ï¼š123456</p>
    <div class="form-group">
        <input type="password" id="loginPassword" placeholder="ç®¡ç†å‘˜å¯†ç " required style="margin-bottom: 10px;">
    </div>
    <button class="action-btn" style="width: 100%; margin-top: 0;" onclick="localLogin()">ç™»å½•ç³»ç»Ÿ</button>
</div>

<div id="app-content" style="display:none;">
    <div class="container">
        <div class="top-tools">
            <span>ğŸ’¾ æ•°æ®å®‰å…¨ï¼š</span>
            <button class="link-btn" onclick="localLogout()">é€€å‡ºç™»å½•</button>
            <button class="link-btn" onclick="exportData()">å¯¼å‡ºå¤‡ä»½ (æœ¬åœ°)</button>
            <button class="link-btn" onclick="document.getElementById('fileInput').click()">æ¢å¤æ•°æ® (å¯¼å…¥)</button>
            <input type="file" id="fileInput" style="display:none" onchange="importData(this)" accept=".json">
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('record')">ğŸ“ æŠ„è¡¨å½•å…¥</button>
            <button class="tab-btn" onclick="switchTab('display')">ğŸ§¾ ç”Ÿæˆè´¦å•</button>
        </div>

        <div id="record-page" class="page active">
            <h2>å½“æœˆæŠ„è¡¨å½•å…¥</h2>
            <form id="recordForm">
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>é€‰æ‹©æˆ¿å·</label>
                        <select id="inputRoom" onchange="loadSmartPrevData()">
                            </select>
                    </div>
                    <div class="form-col form-group">
                        <label>æŠ„è¡¨æ—¥æœŸ</label>
                        <input type="date" id="inputDate" onchange="loadSmartPrevData()" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col form-group">
                        <label>ğŸ’° å›ºå®šç§Ÿé‡‘ (å¯ä¿®æ”¹)</label>
                        <input type="number" id="inputRent" class="money-input">
                    </div>
                    <div class="form-col form-group">
                        <label>ğŸ’° å½“å‰æŠ¼é‡‘ (å¯ä¿®æ”¹)</label>
                        <input type="number" id="inputDeposit" class="money-input">
                    </div>
                </div>

                <hr>
                
                <div class="form-row">
                    <div class="form-col form-group">
                        <label>ğŸ’§ ä¸Šæ¬¡æ°´è¡¨</label>
                        <input type="number" id="prevWater" placeholder="è‡ªåŠ¨åŠ è½½" readonly>
                        <small style="color:#888; font-size:12px">æ—¥æœŸ: <span id="txtPrevWaterDate">--</span></small>
                    </div>
                    <div class="form-col form-group">
                        <label>ğŸ’§ æœ¬æ¬¡æ°´è¡¨</label>
                        <input type="number" id="currWater" placeholder="è¾“å…¥è¯»æ•°" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col form-group">
                        <label>âš¡ ä¸Šæ¬¡ç”µè¡¨</label>
                        <input type="number" id="prevElec" placeholder="è‡ªåŠ¨åŠ è½½" readonly>
                        <small style="color:#888; font-size:12px">æ—¥æœŸ: <span id="txtPrevElecDate">--</span></small>
                    </div>
                    <div class="form-col form-group">
                        <label>âš¡ æœ¬æ¬¡ç”µè¡¨</label>
                        <input type="number" id="currElec" placeholder="è¾“å…¥è¯»æ•°" required>
                    </div>
                </div>

                <button type="button" class="action-btn" onclick="saveRecord()">ä¿å­˜è®°å½• & æ›´æ–°é‡‘é¢è®¾ç½®</button>
            </form>
        </div>

        <div id="display-page" class="page">
            <h2>ç§Ÿæˆ·æ”¶ç§Ÿå•é¢„è§ˆ</h2>
            <div class="form-row" style="margin-bottom: 20px; align-items: flex-end;">
                <div class="form-col form-group">
                    <label>é€‰æ‹©æˆ¿å·</label>
                    <select id="viewRoom" onchange="populateRecordDates()">
                        </select>
                </div>
                <div class="form-col form-group">
                    <label>é€‰æ‹©æŠ„è¡¨è®°å½•</label>
                    <select id="viewRecordDate">
                        <option value="">è¯·é€‰æ‹©...</option>
                    </select>
                </div>
                <div class="form-col form-group">
                    <button class="action-btn" style="margin:0; height: 43px;" onclick="generateBill()">ç”Ÿæˆè´¦å•</button>
                </div>
            </div>

            <div id="billArea" class="bill-preview" style="display:none;">
                <div class="bill-header">
                    <h3>æˆ¿å±‹ç§Ÿèµè´¹æ°´ç”µè´¹ç»“ç®—å•</h3>
                    <p>è´¹ç”¨æ‰€å±æœˆä»½ï¼š<span id="billMonthTitle" style="font-weight:bold; color:black;">--</span></p>
                </div>
                
                <div class="bill-info">
                    <span id="billRoom">æˆ¿å·ï¼š101</span>
                    <span id="billDate">æŠ„è¡¨æ—¥ï¼š2025-02-05</span>
                </div>

                <table class="bill-table">
                    <thead>
                        <tr>
                            <th>é¡¹ç›®</th>
                            <th>ä¸Šæ¬¡è¯»æ•°</th>
                            <th>æœ¬æ¬¡è¯»æ•°</th>
                            <th>å®ç”¨é‡</th>
                            <th>å•ä»·</th>
                            <th>é‡‘é¢ (å…ƒ)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>æ°´è´¹</td>
                            <td id="tPrevWater">0</td>
                            <td id="tCurrWater">0</td>
                            <td id="tUseWater">0</td>
                            <td>5.00</td>
                            <td id="tCostWater">0.00</td>
                        </tr>
                        <tr>
                            <td>ç”µè´¹</td>
                            <td id="tPrevElec">0</td>
                            <td id="tCurrElec">0</td>
                            <td id="tUseElec">0</td>
                            <td>0.80</td>
                            <td id="tCostElec">0.00</td>
                        </tr>
                        <tr>
                            <td>æˆ¿ç§Ÿ</td>
                            <td colspan="4">å›ºå®šæœˆç§Ÿ</td>
                            <td id="tRent">3000.00</td>
                        </tr>
                        <tr style="background:#fafafa; color:#666;">
                            <td>æŠ¼é‡‘</td>
                            <td colspan="4">å½“å‰åœ¨æŠ¼é‡‘é¢ (ä»…å±•ç¤º)</td>
                            <td id="tDeposit">3000.00</td>
                        </tr>
                    </tbody>
                </table>

                <div class="total-section">
                    æœ¬æœˆåˆè®¡åº”ç¼´ï¼š<span style="color:red; font-size:24px;">Â¥ <span id="tTotal">0.00</span></span>
                </div>

                <div class="bill-footer">
                    <span>è¯·æŒ‰æ—¶ç¼´çº³è´¹ç”¨ï¼Œè°¢è°¢é…åˆã€‚</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    // ================= é…ç½®ä¸åˆå§‹åŒ– (æœ¬åœ°å­˜å‚¨ç‰ˆ) =================

    const DB_KEY = 'RENT_MANAGER_DATA';
    const ADMIN_PASSWORD = '123456'; // ç®¡ç†å‘˜å¯†ç 
    const ROOM_LIST = ["101", "201", "202", "203", "204", "301", "302", "303", "304"];
    const PRICE_WATER = 5.0;
    const PRICE_ELEC = 0.8;
    let db = []; // å†…å­˜ä¸­çš„æ•°æ®

    window.onload = function() {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            handleLoginState(true);
        }
        
        // é»˜è®¤é€‰ä¸­ä»Šå¤©
        document.getElementById('inputDate').valueAsDate = new Date();
    };

    // ================= æƒé™æ§åˆ¶é€»è¾‘ (æœ¬åœ°Session) =================
    
    function handleLoginState(isLoggedIn) {
        if (isLoggedIn) {
            // å·²ç™»å½•ï¼šæ˜¾ç¤ºåº”ç”¨å†…å®¹
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            
            initDB(); // åˆå§‹åŒ–æ•°æ®åº“ï¼ˆä»æœ¬åœ°å­˜å‚¨åŠ è½½æˆ–åˆ›å»ºåˆå§‹æ•°æ®ï¼‰
            populateSelects();
            loadSmartPrevData();
            showToast("æ¬¢è¿å›æ¥ï¼");
        } else {
            // æœªç™»å½•ï¼šæ˜¾ç¤ºç™»å½•é¡µé¢
            document.getElementById('auth-page').style.display = 'block';
            document.getElementById('app-content').style.display = 'none';
            sessionStorage.removeItem('isLoggedIn'); // ç¡®ä¿çŠ¶æ€æ¸…é™¤
        }
    }
    
    function localLogin() {
        const password = document.getElementById('loginPassword').value;
        
        if (password === ADMIN_PASSWORD) {
            sessionStorage.setItem('isLoggedIn', 'true'); // æ ‡è®°å·²ç™»å½•
            handleLoginState(true);
        } else {
            alert("ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®ã€‚");
        }
    }
    
    function localLogout() {
        sessionStorage.removeItem('isLoggedIn');
        handleLoginState(false);
        showToast("å·²å®‰å…¨é€€å‡º");
    }


    // ================= æ•°æ®å±‚é€»è¾‘ (LocalStorage) =================

    // ä»æœ¬åœ°å­˜å‚¨è·å–æ•°æ®
    function getDB() {
        const dataStr = localStorage.getItem(DB_KEY);
        if (dataStr) {
            db = JSON.parse(dataStr);
        } else {
            db = [];
        }
        return db;
    }
    
    // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    function saveDB(data) {
        localStorage.setItem(DB_KEY, JSON.stringify(data));
        db = data; // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
    }
    
    // åˆå§‹åŒ–æ•°æ®åº“ï¼šå¦‚æœæœ¬åœ°å­˜å‚¨æ²¡æœ‰æ•°æ®ï¼Œåˆ™æ‰¹é‡åˆ›å»º 9 ä¸ªæˆ¿å·çš„åˆå§‹è®°å½•
    function initDB() {
        getDB(); // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        
        if (db.length === 0) {
            const initialData = ROOM_LIST.map(room => ({
                æˆ¿å·: room,
                å›ºå®šç§Ÿé‡‘: 3000,
                æŠ¼é‡‘: 3000,
                æ°´ç”µè´¹è®°å½•: [],
            }));
            saveDB(initialData);
            showToast("âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼Œè¯·å¼€å§‹å½•å…¥ï¼");
        }
    }

    // ================= UI äº¤äº’ & æ ¸å¿ƒåŠŸèƒ½ (ä¸äº‘ç«¯ç‰ˆé€»è¾‘ç›¸åŒ) =================

    // å¡«å……æˆ¿å·ä¸‹æ‹‰èœå•
    function populateSelects() {
        const rooms = getDB();
        const inputSelect = document.getElementById('inputRoom');
        const viewSelect = document.getElementById('viewRoom');
        
        inputSelect.innerHTML = '';
        viewSelect.innerHTML = '';

        rooms.forEach(room => {
            const opt = new Option(`${room.æˆ¿å·}`, room.æˆ¿å·);
            inputSelect.add(opt);
            viewSelect.add(new Option(`${room.æˆ¿å·}`, room.æˆ¿å·));
        });
        
        if (rooms.length > 0) {
             loadSmartPrevData();
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabName + '-page').classList.add('active');
        const btns = document.querySelectorAll('.tab-btn');
        if(tabName === 'record') btns[0].classList.add('active');
        else {
            btns[1].classList.add('active');
            if (document.getElementById('viewRoom').value) {
                populateRecordDates(); 
            }
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    // A: æŠ„è¡¨å½•å…¥
    function loadSmartPrevData() {
        const roomId = document.getElementById('inputRoom').value;
        const inputDate = document.getElementById('inputDate').value;
        
        if (!roomId || !inputDate) return;

        const tenant = getDB().find(t => t.æˆ¿å· === roomId);

        if (!tenant) return;

        // 1. å¡«å……åŸºç¡€ä¿¡æ¯
        document.getElementById('inputRent').value = tenant.å›ºå®šç§Ÿé‡‘;
        document.getElementById('inputDeposit').value = tenant.æŠ¼é‡‘ || 0;
        
        // 2. æŸ¥æ‰¾æ˜¯å¦ä»Šå¤©å·²ç»å½•è¿‡ (ç”¨äºå›æ˜¾ä¿®æ”¹)
        const currentRecord = tenant.æ°´ç”µè´¹è®°å½•.find(r => r.æ—¥æœŸ === inputDate);
        if (currentRecord) {
            document.getElementById('currWater').value = currentRecord.æœ¬æœˆæ°´è¡¨;
            document.getElementById('currElec').value = currentRecord.æœ¬æœˆç”µè¡¨;
        } else {
            document.getElementById('currWater').value = '';
            document.getElementById('currElec').value = '';
        }

        // 3. æ™ºèƒ½æŸ¥æ‰¾â€œä¸Šæ¬¡è¯»æ•°â€ï¼šæ—¥æœŸ < é€‰å®šæ—¥æœŸçš„æœ€æ–°ä¸€æ¡
        const sortedRecords = [...tenant.æ°´ç”µè´¹è®°å½•].sort((a, b) => new Date(b.æ—¥æœŸ) - new Date(a.æ—¥æœŸ));
        const prevRecord = sortedRecords.find(r => new Date(r.æ—¥æœŸ) < new Date(inputDate));

        if (prevRecord) {
            document.getElementById('prevWater').value = prevRecord.æœ¬æœˆæ°´è¡¨;
            document.getElementById('prevElec').value = prevRecord.æœ¬æœˆç”µè¡¨;
            document.getElementById('txtPrevWaterDate').innerText = prevRecord.æ—¥æœŸ;
            document.getElementById('txtPrevElecDate').innerText = prevRecord.æ—¥æœŸ;
            document.getElementById('prevWater').readOnly = true;
            document.getElementById('prevElec').readOnly = true;
        } else {
            document.getElementById('prevWater').value = 0;
            document.getElementById('prevElec').value = 0;
            document.getElementById('txtPrevWaterDate').innerText = "æ— ";
            document.getElementById('txtPrevElecDate').innerText = "æ— ";
            document.getElementById('prevWater').readOnly = false;
            document.getElementById('prevElec').readOnly = false;
        }
    }

    function saveRecord() {
        const roomId = document.getElementById('inputRoom').value;
        const date = document.getElementById('inputDate').value;
        
        const rent = parseFloat(document.getElementById('inputRent').value) || 0;
        const deposit = parseFloat(document.getElementById('inputDeposit').value) || 0;
        
        const prevWater = parseFloat(document.getElementById('prevWater').value);
        const currWater = parseFloat(document.getElementById('currWater').value);
        const prevElec = parseFloat(document.getElementById('prevElec').value);
        const currElec = parseFloat(document.getElementById('currElec').value);

        if (!date) return alert("è¯·é€‰æ‹©æ—¥æœŸ");
        if (isNaN(currWater) || isNaN(currElec) || isNaN(prevWater) || isNaN(prevElec)) {
            alert("è¯·å®Œæ•´å¡«å†™æ°´ç”µè¯»æ•°");
            return;
        }
        if (currWater < prevWater || currElec < prevElec) {
            alert("æœ¬æ¬¡æŠ„è¡¨æ•°ä¸èƒ½å°äºä¸Šæ¬¡æŠ„è¡¨æ•°ï¼è¯·æ£€æŸ¥è¾“å…¥ã€‚");
            return;
        }

        const tIdx = db.findIndex(t => t.æˆ¿å· === roomId);
        
        if (tIdx === -1) {
             return alert("æ‰¾ä¸åˆ°è¯¥æˆ¿å·è®°å½•ï¼");
        }
        
        const newRecord = {
            æ—¥æœŸ: date,
            ä¸Šæœˆæ°´è¡¨: prevWater,
            æœ¬æœˆæ°´è¡¨: currWater,
            ä¸Šæœˆç”µè¡¨: prevElec,
            æœ¬æœˆç”µè¡¨: currElec,
            å½“æœˆæˆ¿ç§Ÿå¿«ç…§: rent 
        };

        let currentRecords = db[tIdx].æ°´ç”µè´¹è®°å½•;

        const rIdx = currentRecords.findIndex(r => r.æ—¥æœŸ === date);
        if (rIdx !== -1) {
            if(!confirm(`âš ï¸ ${date} çš„è®°å½•å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) return;
            currentRecords[rIdx] = newRecord;
        } else {
            currentRecords.push(newRecord);
        }

        currentRecords.sort((a, b) => new Date(a.æ—¥æœŸ) - new Date(b.æ—¥æœŸ));
        
        // æ›´æ–°ç§Ÿæˆ·çš„å›ºå®šä¿¡æ¯å’Œè®°å½•
        db[tIdx].æ°´ç”µè´¹è®°å½• = currentRecords;
        db[tIdx].å›ºå®šç§Ÿé‡‘ = rent;
        db[tIdx].æŠ¼é‡‘ = deposit;

        saveDB(db); // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨

        showToast("âœ… æœ¬åœ°æ•°æ®ä¿å­˜æˆåŠŸ (é‡‘é¢è®¾ç½®å·²æ›´æ–°)");
            
        // åˆ·æ–° UI
        populateSelects();
        loadSmartPrevData();
        document.getElementById('currWater').value = '';
        document.getElementById('currElec').value = '';
    }

    // B: è´¦å•ç”Ÿæˆ
    function populateRecordDates() {
        const roomId = document.getElementById('viewRoom').value;
        const select = document.getElementById('viewRecordDate');
        select.innerHTML = '<option value="">-- é€‰æ‹©æŠ„è¡¨æ—¥æœŸ --</option>';

        const tenant = getDB().find(t => t.æˆ¿å· === roomId);

        if (tenant && tenant.æ°´ç”µè´¹è®°å½•.length > 0) {
            [...tenant.æ°´ç”µè´¹è®°å½•].reverse().forEach(r => {
                select.add(new Option(r.æ—¥æœŸ, r.æ—¥æœŸ));
            });
        }
    }

    function generateBill() {
        const roomId = document.getElementById('viewRoom').value;
        const date = document.getElementById('viewRecordDate').value;
        const billArea = document.getElementById('billArea');

        if(!date) return alert("è¯·é€‰æ‹©ä¸€ä¸ªæ—¥æœŸ");

        const tenant = getDB().find(t => t.æˆ¿å· === roomId);
        const record = tenant.æ°´ç”µè´¹è®°å½•.find(r => r.æ—¥æœŸ === date);

        billArea.style.display = 'block';

        // 1. è®¡ç®—è´¹ç”¨æ‰€å±æœˆä»½
        const dObj = new Date(date);
        dObj.setDate(dObj.getDate() + 1); 
        dObj.setMonth(dObj.getMonth() - 1);
        const billMonthStr = `${dObj.getFullYear()}å¹´${dObj.getMonth() + 1}æœˆ`;

        // 2. è®¡ç®—è´¹ç”¨
        const wUse = (record.æœ¬æœˆæ°´è¡¨ - record.ä¸Šæœˆæ°´è¡¨);
        const eUse = (record.æœ¬æœˆç”µè¡¨ - record.ä¸Šæœˆç”µè¡¨);
        const wCost = wUse * PRICE_WATER;
        const eCost = eUse * PRICE_ELEC;
        
        const rentCost = record.å½“æœˆæˆ¿ç§Ÿå¿«ç…§ !== undefined ? record.å½“æœˆæˆ¿ç§Ÿå¿«ç…§ : tenant.å›ºå®šç§Ÿé‡‘;
        const total = wCost + eCost + rentCost;

        // 3. å¡«å…… DOM
        document.getElementById('billMonthTitle').innerText = billMonthStr;
        document.getElementById('billRoom').innerText = `æˆ¿å·ï¼š${tenant.æˆ¿å·}`;
        document.getElementById('billDate').innerText = `æŠ„è¡¨æ—¥ï¼š${date}`; 

        document.getElementById('tPrevWater').innerText = record.ä¸Šæœˆæ°´è¡¨.toFixed(2);
        document.getElementById('tCurrWater').innerText = record.æœ¬æœˆæ°´è¡¨.toFixed(2);
        document.getElementById('tUseWater').innerText = wUse.toFixed(2);
        document.getElementById('tCostWater').innerText = wCost.toFixed(2);

        document.getElementById('tPrevElec').innerText = record.ä¸Šæœˆç”µè¡¨.toFixed(2);
        document.getElementById('tCurrElec').innerText = record.æœ¬æœˆç”µè¡¨.toFixed(2);
        document.getElementById('tUseElec').innerText = eUse.toFixed(2);
        document.getElementById('tCostElec').innerText = eCost.toFixed(2);

        document.getElementById('tRent').innerText = rentCost.toFixed(2);
        document.getElementById('tDeposit').innerText = tenant.æŠ¼é‡‘.toFixed(2); 

        document.getElementById('tTotal').innerText = total.toFixed(2);
    }

    // æ•°æ®å¤‡ä»½ä¸æ¢å¤ (LocalStorage)

    function exportData() {
        const data = localStorage.getItem(DB_KEY);
        if (!data) return alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
        
        const jsonString = JSON.stringify(JSON.parse(data), null, 2);
        const blob = new Blob([jsonString], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `æˆ¿ç§Ÿå¤‡ä»½_æœ¬åœ°_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        showToast("âœ… æœ¬åœ°æ•°æ®å·²å¯¼å‡ºå¤‡ä»½");
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;

        if(!confirm("âš ï¸ ç¡®å®šæ¢å¤æ•°æ®ï¼Ÿå¯¼å…¥çš„æ•°æ®å°†è¦†ç›–æœ¬åœ°æ‰€æœ‰ç°æœ‰è®°å½•ï¼")) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!Array.isArray(importedData) || !importedData[0].æˆ¿å·) {
                    return alert("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿å¯¼å…¥çš„æ˜¯æ­£ç¡®çš„ JSON å¤‡ä»½æ–‡ä»¶ã€‚");
                }
                
                // ç›´æ¥è¦†ç›–æœ¬åœ°å­˜å‚¨
                saveDB(importedData);
                
                showToast("âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼æ­£åœ¨åˆ·æ–°...");
                setTimeout(() => location.reload(), 1000);

            } catch(err) { 
                console.error(err);
                alert("æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹ã€‚"); 
            }
        };
        reader.readAsText(file);
    }
</script>

</body>
</html>
